<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è´´çº¸æ”¶é›†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f7f9fc;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100%;
            min-height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 15px;
            position: relative;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4a6cf7;
            margin: 0;
        }

        .counter-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
        }

        .card {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .gps-display {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .gps-value {
            font-weight: bold;
            color: #4a6cf7;
        }

        .gps-accuracy {
            color: #666;
            font-size: 0.85rem;
        }

        .high-accuracy {
            color: #2ecc71;
        }

        .medium-accuracy {
            color: #f39c12;
        }

        .low-accuracy {
            color: #e74c3c;
        }

        .location-form {
            margin-top: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #4a6cf7;
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }

        .btn {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .btn:active {
            transform: translateY(1px);
            background-color: #3a5ce5;
        }

        .btn-disabled {
            background-color: #b3b3b3;
            cursor: not-allowed;
        }

        .progress-container {
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #4a6cf7;
            width: 0%;
            transition: width 1s linear;
        }

        .stickers-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .sticker {
            background-color: #f8f9fa;
            border-radius: 12px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            animation: popIn 0.3s forwards;
            transition: transform 0.2s ease;
        }

        .sticker:active {
            transform: scale(0.95);
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            70% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .sticker-info {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .sticker-info.show {
            transform: translateY(0);
        }

        .sticker-info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .sticker-info-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #555;
            cursor: pointer;
        }

        .sticker-detail {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 0.9rem;
        }

        .sticker-detail-item {
            display: flex;
            justify-content: space-between;
        }

        .sticker-detail-label {
            color: #777;
        }

        .sticker-detail-value {
            font-weight: 500;
        }

        .status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            z-index: 200;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .status-message.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .loading-text {
            margin-top: 15px;
            font-size: 1rem;
            color: #333;
        }

        .saved-locations {
            margin-top: 15px;
        }

        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 10px;
            border-left: 4px solid #4a6cf7;
        }

        .location-name {
            font-weight: 500;
        }

        .location-coords {
            font-size: 0.8rem;
            color: #666;
        }

        .location-actions button {
            background: none;
            border: none;
            color: #4a6cf7;
            cursor: pointer;
            padding: 5px;
            margin-left: 5px;
            font-size: 1rem;
        }

        .tab-container {
            margin-top: auto;
            display: flex;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            background-color: white;
        }

        .tab {
            flex: 1;
            padding: 15px 0;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .tab.active {
            background-color: #4a6cf7;
            color: white;
        }

        .tab-content {
            display: none;
            margin-bottom: 15px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>è´´çº¸æ”¶é›†å™¨</h1>
            <div id="sticker-count" class="counter-badge">0</div>
        </header>

        <div id="tab-content-collect" class="tab-content active">
            <!-- GPSå¡ç‰‡ -->
            <div class="card">
                <div class="gps-display">
                    <div>çº¬åº¦: <span id="latitude" class="gps-value">--</span></div>
                    <div>ç»åº¦: <span id="longitude" class="gps-value">--</span></div>
                    <div>ç²¾åº¦: <span id="accuracy" class="gps-value">--</span></div>
                    <div class="gps-accuracy" id="accuracy-message">æ­£åœ¨è·å–ä½ç½®...</div>
                </div>

                <div class="progress-container">
                    <div id="collect-progress" class="progress-bar"></div>
                </div>

                <div class="location-form">
                    <div class="form-group">
                        <label for="location-name">ä½ç½®åç§°</label>
                        <input type="text" id="location-name" placeholder="ç»™è¿™ä¸ªä½ç½®èµ·ä¸ªåå­—...">
                    </div>
                    <div style="display: flex; gap: 10px;">  
                        <button id="choose-sticker-btn" class="btn btn-disabled" disabled style="flex: 1;">é€‰æ‹©è´´çº¸</button>
                        <button id="save-location-btn" class="btn btn-disabled" disabled style="flex: 2;">ä¿å­˜ä½ç½®</button>
                    </div>
                </div>
            </div>

            <!-- æ”¶é›†çŠ¶æ€ -->
            <div class="card">
                <h2>å½“å‰çŠ¶æ€</h2>
                <div id="status-text">æ­£åœ¨ç­‰å¾…ä½ç½®æ•°æ®...</div>
            </div>
        </div>

        <div id="tab-content-stickers" class="tab-content">
            <div class="card">
                <h2>æˆ‘çš„è´´çº¸</h2>
                <div id="stickers-container" class="stickers-container">
                    <!-- è´´çº¸å°†åŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>

        <div id="tab-content-locations" class="tab-content">
            <div class="card">
                <h2>å·²ä¿å­˜çš„ä½ç½®</h2>
                <div id="saved-locations" class="saved-locations">
                    <!-- ä¿å­˜çš„ä½ç½®å°†åŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>

        <div class="tab-container">
            <div id="tab-collect" class="tab active" data-tab="collect">æ”¶é›†</div>
            <div id="tab-stickers" class="tab" data-tab="stickers">è´´çº¸</div>
            <div id="tab-locations" class="tab" data-tab="locations">ä½ç½®</div>
        </div>
    </div>

    <div id="sticker-info" class="sticker-info">
        <div class="sticker-info-header">
            <div class="sticker-info-title">è´´çº¸ä¿¡æ¯</div>
            <button id="close-sticker-info" class="close-btn">Ã—</button>
        </div>
        <div id="sticker-detail" class="sticker-detail">
            <!-- è´´çº¸è¯¦æƒ…å°†åŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
        </div>
    </div>

    <div id="status-message" class="status-message"></div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å…ƒç´ 
            const latitudeElement = document.getElementById('latitude');
            const longitudeElement = document.getElementById('longitude');
            const accuracyElement = document.getElementById('accuracy');
            const accuracyMessageElement = document.getElementById('accuracy-message');
            const locationNameInput = document.getElementById('location-name');
            const saveLocationBtn = document.getElementById('save-location-btn');
            const statusText = document.getElementById('status-text');
            const stickersContainer = document.getElementById('stickers-container');
            const savedLocationsContainer = document.getElementById('saved-locations');
            const collectProgress = document.getElementById('collect-progress');
            const stickerCountElement = document.getElementById('sticker-count');
            const stickerInfo = document.getElementById('sticker-info');
            const closeStickerInfo = document.getElementById('close-sticker-info');
            const stickerDetail = document.getElementById('sticker-detail');
            const statusMessage = document.getElementById('status-message');
            const loadingOverlay = document.getElementById('loading-overlay');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            // å˜é‡
            let currentPosition = null;
            let locationWatchId = null;
            let collectionTimer = null;
            let collectCounter = 0;
            let isCollecting = false;
            let savedLocations = [];
            let collectedStickers = [];
            let activeTab = 'collect';
            let selectedSticker = null; // é€‰æ‹©çš„è´´çº¸
            
            // è®¡ç®—ä¸¤ä¸ªGPSä½ç½®ä¹‹é—´çš„è·ç¦»ï¼ˆä»¥ç±³ä¸ºå•ä½ï¼‰
            function calculateDistance(pos1, pos2) {
                // ä½¿ç”¨Haversineå…¬å¼è®¡ç®—åœ°çƒè¡¨é¢ä¸¤ç‚¹é—´è·ç¦»
                const R = 6371000; // åœ°çƒåŠå¾„ï¼Œå•ä½ç±³
                const lat1 = pos1.latitude * Math.PI / 180;
                const lat2 = pos2.latitude * Math.PI / 180;
                const deltaLat = (pos2.latitude - pos1.latitude) * Math.PI / 180;
                const deltaLon = (pos2.longitude - pos1.longitude) * Math.PI / 180;
                
                const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                          Math.cos(lat1) * Math.cos(lat2) *
                          Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c; // è¿”å›è·ç¦»ï¼Œå•ä½ç±³
            }
            
            // æŸ¥æ‰¾è·ç¦»å½“å‰ä½ç½®æŒ‡å®šèŒƒå›´å†…çš„æœ€è¿‘ä½ç½®
            function findNearbyLocation(currentPos, radiusInMeters) {
                if (!savedLocations || savedLocations.length === 0) {
                    return null;
                }
                
                let nearestLocation = null;
                let minDistance = Infinity;
                
                savedLocations.forEach(location => {
                    const distance = calculateDistance(
                        {latitude: currentPos.latitude, longitude: currentPos.longitude},
                        {latitude: location.latitude, longitude: location.longitude}
                    );
                    
                    if (distance <= radiusInMeters && distance < minDistance) {
                        minDistance = distance;
                        nearestLocation = location;
                    }
                });
                
                return nearestLocation;
            }

            // è´´çº¸è¡¨æƒ…æ•°ç»„
            const stickerEmojis = [
                'ğŸŒŸ', 'ğŸŒˆ', 'ğŸŒ¸', 'ğŸ€', 'ğŸŒº', 'ğŸŒ»', 'ğŸ¦‹', 'ğŸ¢', 
                'ğŸ¬', 'ğŸ¦„', 'ğŸ¦', 'ğŸ­', 'ğŸ¨', 'ğŸ­', 'ğŸª', 'ğŸ¡',
                'ğŸ¢', 'ğŸ ', 'ğŸ®', 'ğŸ§¸', 'ğŸª', 'ğŸ²', 'ğŸ¯', 'ğŸ§©',
                'ğŸŒµ', 'ğŸŒ´', 'ğŸŒ²', 'ğŸ„', 'ğŸŒ', 'ğŸŒ', 'â­', 'ğŸŒ™',
                'ğŸ', 'ğŸ“', 'ğŸ‡', 'ğŸ‰', 'ğŸŒ', 'ğŸ¥‘', 'ğŸ’', 'ğŸ¥',
                'ğŸ±', 'ğŸ¶', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¯', 'ğŸ»'
            ];

            // å¯åŠ¨åº”ç”¨
            initApp();

            function initApp() {
                loadSavedData();
                updateStickerCount();
                setupEventListeners();
                startLocationTracking();
            }

            function setupEventListeners() {
                // ä¿å­˜ä½ç½®æŒ‰é’®
                saveLocationBtn.addEventListener('click', saveCurrentLocation);
                
                // é€‰æ‹©è´´çº¸æŒ‰é’®
                const chooseStickerBtn = document.getElementById('choose-sticker-btn');
                chooseStickerBtn.addEventListener('click', showStickerSelector);

                // è´´çº¸è¯¦æƒ…å…³é—­æŒ‰é’®
                closeStickerInfo.addEventListener('click', () => {
                    stickerInfo.classList.remove('show');
                });

                // æ ‡ç­¾åˆ‡æ¢
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        switchTab(tabId);
                    });
                });

                // é˜»æ­¢è§¦æ‘¸äº‹ä»¶é»˜è®¤è¡Œä¸ºï¼ˆé˜²æ­¢åŒå‡»ç¼©æ”¾ï¼‰
                document.addEventListener('touchstart', function(event) {
                    if(event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });

                // é˜²æ­¢ç¼©æ”¾
                document.addEventListener('gesturestart', function(e) {
                    e.preventDefault();
                });
            }

            function switchTab(tabId) {
                // æ›´æ–°æ¿€æ´»æ ‡ç­¾
                activeTab = tabId;

                // æ›´æ–°æ ‡ç­¾æ ·å¼
                tabs.forEach(tab => {
                    if (tab.getAttribute('data-tab') === tabId) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                // æ›´æ–°å†…å®¹æ˜¾ç¤º
                tabContents.forEach(content => {
                    if (content.id === `tab-content-${tabId}`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });

                // å¦‚æœåˆ‡æ¢åˆ°ä½ç½®æ ‡ç­¾ï¼Œåˆ·æ–°ä½ç½®åˆ—è¡¨
                if (tabId === 'locations') {
                    renderSavedLocations();
                } else if (tabId === 'stickers') {
                    renderStickers();
                }
            }

            function startLocationTracking() {
                showLoading(true, 'æ­£åœ¨è·å–ä½ç½®...');

                // æ£€æŸ¥åœ°ç†ä½ç½®APIæ˜¯å¦å¯ç”¨
                if (!navigator.geolocation) {
                    updateStatusText('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡');
                    showLoading(false);
                    showStatusMessage('æ— æ³•è·å–ä½ç½®ä¿¡æ¯', true);
                    return;
                }

                // è·å–ä½ç½®æƒé™
                const options = {
                    enableHighAccuracy: true, // ä½¿ç”¨é«˜ç²¾åº¦
                    timeout: 10000,           // è¶…æ—¶æ—¶é—´
                    maximumAge: 0             // ä¸ä½¿ç”¨ç¼“å­˜
                };

                try {
                    // æŒç»­ç›‘å¬ä½ç½®
                    locationWatchId = navigator.geolocation.watchPosition(
                        positionUpdate,
                        locationError,
                        options
                    );
                } catch (error) {
                    updateStatusText(`ä½ç½®æœåŠ¡é”™è¯¯: ${error.message}`);
                    showLoading(false);
                    showStatusMessage('è·å–ä½ç½®æƒé™å¤±è´¥', true);
                }
            }

            function positionUpdate(position) {
                showLoading(false);

                // æ›´æ–°ä½ç½®ä¿¡æ¯æ˜¾ç¤º
                const { latitude, longitude, accuracy } = position.coords;
                latitudeElement.textContent = latitude.toFixed(6);
                longitudeElement.textContent = longitude.toFixed(6);
                accuracyElement.textContent = `${accuracy.toFixed(1)}ç±³`;

                // æ›´æ–°ç²¾åº¦æŒ‡ç¤ºå™¨
                updateAccuracyIndicator(accuracy);

                // ä¿å­˜å½“å‰ä½ç½®
                const newPosition = {
                    latitude,
                    longitude,
                    accuracy,
                    timestamp: position.timestamp
                };

                // å¦‚æœå½“å‰æ²¡æœ‰ä½ç½®æˆ–ä½ç½®å˜åŒ–è¾ƒå¤§ï¼Œåˆ™é‡ç½®è®¡æ—¶å™¨
                if (!currentPosition || hasPositionChanged(currentPosition, newPosition)) {
                    resetCollectionProgress();
                    updateStatusText('æ£€æµ‹åˆ°æ–°ä½ç½®ï¼Œä¿æŒé™æ­¢ä»¥æ”¶é›†è´´çº¸');
                } else {
                    // å¦‚æœä½ç½®æ²¡æœ‰æ˜¾è‘—å˜åŒ–ï¼Œå¼€å§‹æˆ–ç»§ç»­è®¡æ—¶
                    startCollectionTimer();
                }

                // æ›´æ–°å½“å‰ä½ç½®
                currentPosition = newPosition;

                // å¯ç”¨ä¿å­˜ä½ç½®æŒ‰é’®å’Œé€‰æ‹©è´´çº¸æŒ‰é’®
                saveLocationBtn.disabled = false;
                saveLocationBtn.classList.remove('btn-disabled');
                
                const chooseStickerBtn = document.getElementById('choose-sticker-btn');
                chooseStickerBtn.disabled = false;
                chooseStickerBtn.classList.remove('btn-disabled');
            }

            function locationError(error) {
                showLoading(false);

                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'ä½ç½®æƒé™è¢«æ‹’ç»';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'è·å–ä½ç½®è¶…æ—¶';
                        break;
                    default:
                        errorMessage = 'ä½ç½®æœåŠ¡é”™è¯¯';
                }

                updateStatusText(`é”™è¯¯: ${errorMessage}`);
                showStatusMessage(errorMessage, true);
            }

            function hasPositionChanged(oldPos, newPos) {
                // è®¡ç®—ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·ç¦»æ˜¯å¦è¶…è¿‡ç²¾åº¦èŒƒå›´
                // ç®€å•åˆ¤æ–­ï¼šå¦‚æœç»çº¬åº¦å˜åŒ–è¶…è¿‡ä¸€å®šé˜ˆå€¼åˆ™è®¤ä¸ºä½ç½®æœ‰å˜åŒ–
                const latChange = Math.abs(oldPos.latitude - newPos.latitude);
                const lngChange = Math.abs(oldPos.longitude - newPos.longitude);

                // æ ¹æ®ç²¾åº¦åŠ¨æ€è°ƒæ•´é˜ˆå€¼
                const threshold = Math.max(5, newPos.accuracy) / 111000; // ç²—ç•¥æ¢ç®—ï¼Œ1åº¦çº¦ç­‰äº111å…¬é‡Œ

                return latChange > threshold || lngChange > threshold;
            }

            function updateAccuracyIndicator(accuracy) {
                let message = '';
                let className = '';

                if (accuracy <= 10) {
                    message = 'ç²¾åº¦é«˜ ğŸ‘';
                    className = 'high-accuracy';
                } else if (accuracy <= 50) {
                    message = 'ç²¾åº¦ä¸­ç­‰';
                    className = 'medium-accuracy';
                } else {
                    message = 'ç²¾åº¦ä½ï¼Œè¯·å°½é‡åˆ°æˆ·å¤–å¼€é˜”åŒºåŸŸ';
                    className = 'low-accuracy';
                }

                accuracyMessageElement.textContent = message;
                accuracyMessageElement.className = 'gps-accuracy ' + className;
            }

            function startCollectionTimer() {
                if (isCollecting) return; // å·²ç»åœ¨æ”¶é›†ä¸­

                isCollecting = true;
                collectCounter = 0;

                updateStatusText('ä¿æŒä½ç½®ä¸å˜ï¼Œæ­£åœ¨æ”¶é›†è´´çº¸...');

                // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
                collectionTimer = setInterval(() => {
                    collectCounter++;
                    updateCollectionProgress(collectCounter);

                    if (collectCounter >= 10) {
                        // æ”¶é›†å®Œæˆï¼Œè·å¾—è´´çº¸
                        collectSticker();
                        resetCollectionProgress();
                    }
                }, 1000);
            }

            function updateCollectionProgress(seconds) {
                const percentage = (seconds / 10) * 100;
                collectProgress.style.width = `${percentage}%`;
            }

            function resetCollectionProgress() {
                // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
                if (collectionTimer) {
                    clearInterval(collectionTimer);
                }

                // é‡ç½®çŠ¶æ€
                isCollecting = false;
                collectCounter = 0;
                collectProgress.style.width = '0%';
            }

            function collectSticker() {
                // æ£€æŸ¥é™„è¿‘15ç±³å†…æ˜¯å¦æœ‰ä¿å­˜çš„ä½ç½®
                const nearbyLocation = findNearbyLocation(currentPosition, 15);
                
                if (!nearbyLocation) {
                    // å¦‚æœæ²¡æ‰¾åˆ°é™„è¿‘ä½ç½®ï¼Œæ˜¾ç¤ºæ¶ˆæ¯å¹¶æå‰è¿”å›
                    showStatusMessage(`éœ€è¦é è¿‘ä¿å­˜çš„ä½ç½®æ‰èƒ½è·å–è´´çº¸ï¼`, true);
                    updateStatusText('è¯·å¯»æ‰¾å·²ä¿å­˜çš„ä½ç½®');
                    return;
                }
                
                // æ‰¾åˆ°é™„è¿‘ä½ç½®ï¼Œç»§ç»­æ”¶é›†è´´çº¸
                let stickerEmoji = nearbyLocation.sticker;
                showStatusMessage(`åœ¨é™„è¿‘æ‰¾åˆ°"${nearbyLocation.name}"ï¼Œè·å¾—å…¶è´´çº¸ï¼`, false);
                
                // åˆ›å»ºæ–°è´´çº¸å¯¹è±¡
                const newSticker = {
                    id: generateUniqueId(),
                    emoji: stickerEmoji,
                    collectedAt: new Date(),
                    location: {
                        latitude: currentPosition.latitude,
                        longitude: currentPosition.longitude,
                        accuracy: currentPosition.accuracy
                    }
                };
                
                // æ”¶é›†å®Œæˆåé‡ç½®é€‰å®šçš„è´´çº¸
                selectedSticker = null;

                // æ·»åŠ åˆ°æ”¶é›†åˆ—è¡¨
                collectedStickers.push(newSticker);

                // ä¿å­˜æ•°æ®
                saveCollectedStickers();

                // æ›´æ–°UI
                updateStickerCount();

                // æ˜¾ç¤ºæ”¶é›†æˆåŠŸæ¶ˆæ¯
                showStatusMessage(`è·å¾—æ–°è´´çº¸ ${stickerEmoji}ï¼`, false);
                
                // åœ¨å±å¹•ä¸­æ˜¾ç¤ºè´´çº¸
                showCollectedStickerAnimation(stickerEmoji);

                // å¦‚æœå½“å‰åœ¨è´´çº¸æ ‡ç­¾é¡µï¼Œåˆ·æ–°æ˜¾ç¤º
                if (activeTab === 'stickers') {
                    renderStickers();
                }

                updateStatusText('æˆåŠŸæ”¶é›†åˆ°è´´çº¸ï¼ä¿æŒä½ç½®ç»§ç»­æ”¶é›†æ›´å¤š');
            }

            function renderStickers() {
                stickersContainer.innerHTML = '';

                if (collectedStickers.length === 0) {
                    stickersContainer.innerHTML = '<p>ä½ è¿˜æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•è´´çº¸ï¼Œä¿æŒåœ¨åŒä¸€ä½ç½®10ç§’å³å¯è·å¾—è´´çº¸ï¼</p>';
                    return;
                }

                collectedStickers.forEach(sticker => {
                    const stickerElement = document.createElement('div');
                    stickerElement.className = 'sticker';
                    stickerElement.textContent = sticker.emoji;

                    // ç‚¹å‡»æŸ¥çœ‹è´´çº¸è¯¦æƒ…
                    stickerElement.addEventListener('click', () => {
                        showStickerDetails(sticker);
                    });

                    stickersContainer.appendChild(stickerElement);
                });
            }

            function showStickerDetails(sticker) {
                const collectedAt = new Date(sticker.collectedAt);

                stickerDetail.innerHTML = `
                    <div class="sticker-detail-item">
                        <span class="sticker-detail-label">è´´çº¸ï¼š</span>
                        <span class="sticker-detail-value">${sticker.emoji}</span>
                    </div>
                    <div class="sticker-detail-item">
                        <span class="sticker-detail-label">æ”¶é›†æ—¶é—´ï¼š</span>
                        <span class="sticker-detail-value">${formatDate(collectedAt)}</span>
                    </div>
                    <div class="sticker-detail-item">
                        <span class="sticker-detail-label">ä½ç½®ï¼š</span>
                        <span class="sticker-detail-value">
                            ${sticker.location.latitude.toFixed(6)}, 
                            ${sticker.location.longitude.toFixed(6)}
                        </span>
                    </div>
                    <div class="sticker-detail-item">
                        <span class="sticker-detail-label">ç²¾åº¦ï¼š</span>
                        <span class="sticker-detail-value">${sticker.location.accuracy.toFixed(1)}ç±³</span>
                    </div>
                `;

                stickerInfo.classList.add('show');
            }

            function saveCurrentLocation() {
                if (!currentPosition) {
                    showStatusMessage('æ— æ³•ä¿å­˜ä½ç½®ï¼šæœªè·å–åˆ°ä½ç½®æ•°æ®', true);
                    return;
                }

                const locationName = locationNameInput.value.trim();
                if (!locationName) {
                    showStatusMessage('è¯·è¾“å…¥ä½ç½®åç§°', true);
                    locationNameInput.focus();
                    return;
                }

                // ä½¿ç”¨é€‰å®šçš„è´´çº¸æˆ–éšæœºé€‰æ‹©ä¸€ä¸ªè´´çº¸
                const locationSticker = selectedSticker ? selectedSticker : stickerEmojis[Math.floor(Math.random() * stickerEmojis.length)];
                
                // åˆ›å»ºä½ç½®å¯¹è±¡
                const newLocation = {
                    id: generateUniqueId(),
                    name: locationName,
                    latitude: currentPosition.latitude,
                    longitude: currentPosition.longitude,
                    accuracy: currentPosition.accuracy,
                    savedAt: new Date(),
                    sticker: locationSticker // ä¿å­˜è¯¥ä½ç½®çš„æŒ‡å®šè´´çº¸
                };

                // æ·»åŠ åˆ°ä¿å­˜çš„ä½ç½®åˆ—è¡¨
                savedLocations.push(newLocation);

                // ä¿å­˜æ•°æ®
                saveSavedLocations();

                // æ¸…ç©ºè¾“å…¥æ¡†
                locationNameInput.value = '';
                
                // æ”¶é›†å®Œæˆåé‡ç½®é€‰å®šçš„è´´çº¸
                selectedSticker = null;

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showStatusMessage('ä½ç½®ä¿å­˜æˆåŠŸï¼', false);

                // å¦‚æœå½“å‰åœ¨ä½ç½®æ ‡ç­¾é¡µï¼Œåˆ·æ–°æ˜¾ç¤º
                if (activeTab === 'locations') {
                    renderSavedLocations();
                }
            }

            function renderSavedLocations() {
                savedLocationsContainer.innerHTML = '';

                if (savedLocations.length === 0) {
                    savedLocationsContainer.innerHTML = '<p>ä½ è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½•ä½ç½®ã€‚</p>';
                    return;
                }

                savedLocations.forEach(location => {
                    const locationElement = document.createElement('div');
                    locationElement.className = 'location-item';

                    locationElement.innerHTML = `
                        <div>
                            <div class="location-name">${location.name} ${location.sticker || ""}</div>
                            <div class="location-coords">${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}</div>
                        </div>
                        <div class="location-actions">
                            <button data-id="${location.id}" class="delete-location">ğŸ—‘ï¸</button>
                        </div>
                    `;

                    // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                    const deleteBtn = locationElement.querySelector('.delete-location');
                    deleteBtn.addEventListener('click', () => {
                        deleteLocation(location.id);
                    });

                    savedLocationsContainer.appendChild(locationElement);
                });
            }

            function deleteLocation(locationId) {
                // ä»æ•°ç»„ä¸­ç§»é™¤æŒ‡å®šIDçš„ä½ç½®
                savedLocations = savedLocations.filter(loc => loc.id !== locationId);

                // ä¿å­˜æ›´æ–°åçš„æ•°æ®
                saveSavedLocations();

                // é‡æ–°æ¸²æŸ“ä½ç½®åˆ—è¡¨
                renderSavedLocations();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showStatusMessage('ä½ç½®å·²åˆ é™¤', false);
            }

            function updateStickerCount() {
                stickerCountElement.textContent = collectedStickers.length;
            }

            function updateStatusText(message) {
                statusText.textContent = message;
            }

            function showStatusMessage(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.style.backgroundColor = isError ? 'rgba(220, 53, 69, 0.8)' : 'rgba(0, 0, 0, 0.7)';
                statusMessage.classList.add('show');

                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    statusMessage.classList.remove('show');
                }, 3000);
            }

            function showLoading(show, message = 'åŠ è½½ä¸­...') {
                if (show) {
                    loadingOverlay.querySelector('.loading-text').textContent = message;
                    loadingOverlay.classList.add('show');
                } else {
                    loadingOverlay.classList.remove('show');
                }
            }

            // æ•°æ®å­˜å‚¨å’ŒåŠ è½½
            function saveCollectedStickers() {
                try {
                    localStorage.setItem('collectedStickers', JSON.stringify(collectedStickers));
                } catch (error) {
                    console.error('ä¿å­˜è´´çº¸æ•°æ®å¤±è´¥:', error);
                }
            }

            function saveSavedLocations() {
                try {
                    localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
                } catch (error) {
                    console.error('ä¿å­˜ä½ç½®æ•°æ®å¤±è´¥:', error);
                }
            }

            function loadSavedData() {
                try {
                    // ç½‘é¡µåŠ è½½æ—¶æ¸…ç©ºè´´çº¸è®°å½•
                    collectedStickers = [];
                    localStorage.removeItem('collectedStickers');
                    
                    // åŠ è½½ä½ç½®æ•°æ®
                    const locationsData = localStorage.getItem('savedLocations');
                    if (locationsData) {
                        savedLocations = JSON.parse(locationsData);
                    }
                } catch (error) {
                    console.error('åŠ è½½ä¿å­˜çš„æ•°æ®å¤±è´¥:', error);
                    collectedStickers = [];
                    savedLocations = [];
                }
            }

            // è¾…åŠ©å‡½æ•°
            function generateUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            function formatDate(date) {
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            // æ˜¾ç¤ºè·å¾—è´´çº¸çš„åŠ¨ç”»
            function showCollectedStickerAnimation(emoji) {
                const animDiv = document.createElement('div');
                animDiv.style.position = 'fixed';
                animDiv.style.top = '40%';
                animDiv.style.left = '50%';
                animDiv.style.transform = 'translate(-50%, -50%)';
                animDiv.style.fontSize = '8rem';
                animDiv.style.zIndex = '1000';
                animDiv.textContent = emoji;
                animDiv.style.transition = 'all 1s ease-in-out';
                animDiv.style.opacity = '0';
                animDiv.style.transform = 'translate(-50%, -50%) scale(0.5)';
                
                document.body.appendChild(animDiv);
                
                setTimeout(() => {
                    animDiv.style.opacity = '1';
                    animDiv.style.transform = 'translate(-50%, -50%) scale(1.2)';
                }, 100);
                
                setTimeout(() => {
                    animDiv.style.opacity = '0';
                    animDiv.style.transform = 'translate(-50%, -50%) scale(0.5)';
                }, 2000);
                
                setTimeout(() => {
                    document.body.removeChild(animDiv);
                }, 3000);
            }
            
            // æ˜¾ç¤ºè´´çº¸é€‰æ‹©å™¨
            function showStickerSelector() {
                // åˆ›å»ºè´´çº¸é€‰æ‹©å™¨å¯¹è¯æ¡†
                const selectorContainer = document.createElement('div');
                selectorContainer.style.position = 'fixed';
                selectorContainer.style.top = '0';
                selectorContainer.style.left = '0';
                selectorContainer.style.width = '100%';
                selectorContainer.style.height = '100%';
                selectorContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                selectorContainer.style.zIndex = '1000';
                selectorContainer.style.display = 'flex';
                selectorContainer.style.flexDirection = 'column';
                selectorContainer.style.justifyContent = 'center';
                selectorContainer.style.alignItems = 'center';
                selectorContainer.style.padding = '20px';
                
                // åˆ›å»ºæ ‡é¢˜
                const title = document.createElement('h2');
                title.textContent = 'é€‰æ‹©ä¸€ä¸ªè´´çº¸';
                title.style.color = 'white';
                title.style.marginBottom = '20px';
                
                // åˆ›å»ºè´´çº¸ç½‘æ ¼
                const stickerGrid = document.createElement('div');
                stickerGrid.style.display = 'grid';
                stickerGrid.style.gridTemplateColumns = 'repeat(5, 1fr)';
                stickerGrid.style.gap = '10px';
                stickerGrid.style.maxHeight = '60vh';
                stickerGrid.style.overflowY = 'auto';
                stickerGrid.style.width = '100%';
                stickerGrid.style.maxWidth = '400px';
                stickerGrid.style.backgroundColor = 'white';
                stickerGrid.style.borderRadius = '10px';
                stickerGrid.style.padding = '15px';
                
                // æ·»åŠ æ‰€æœ‰è´´çº¸
                stickerEmojis.forEach(emoji => {
                    const stickerItem = document.createElement('div');
                    stickerItem.className = 'sticker';
                    stickerItem.textContent = emoji;
                    stickerItem.style.cursor = 'pointer';
                    
                    stickerItem.addEventListener('click', () => {
                        selectedSticker = emoji;
                        document.body.removeChild(selectorContainer);
                        showStatusMessage(`å·²é€‰æ‹©è´´çº¸: ${emoji}ï¼Œåœç•™10ç§’å°†è·å¾—æ­¤è´´çº¸`, false);
                    });
                    
                    stickerGrid.appendChild(stickerItem);
                });
                
                // åˆ›å»ºå–æ¶ˆæŒ‰é’®
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.className = 'btn';
                cancelBtn.style.marginTop = '20px';
                cancelBtn.style.width = '200px';
                
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(selectorContainer);
                });
                
                // ç»„è£…å¯¹è¯æ¡†
                selectorContainer.appendChild(title);
                selectorContainer.appendChild(stickerGrid);
                selectorContainer.appendChild(cancelBtn);
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(selectorContainer);
            }
        });
    </script>
</body>
</html>